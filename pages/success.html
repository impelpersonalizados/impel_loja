<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pagamento confirmado</title>

  <link rel="stylesheet" href="../assets/css/base.css" />
  <link rel="stylesheet" href="../assets/csslayout.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />

  <style>
    .wrap{
      max-width: 560px;
      margin: 40px auto;
      padding: 24px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
    }
    h1{ color:#2b1d43; }
    .muted{ color: var(--muted); }
    .ok{
      margin-top: 16px;
      padding: 14px;
      background: #f0fff6;
      border: 1px solid #b7efd2;
      border-radius: 12px;
      color: #136f3c;
      font-weight: 800;
    }
    .wait{
      margin-top: 16px;
      padding: 14px;
      background: #fff9ec;
      border: 1px solid #ffe1a3;
      border-radius: 12px;
      color: #8a5b00;
      font-weight: 800;
    }
    .err{
      margin-top: 16px;
      padding: 14px;
      background: #fff1f1;
      border: 1px solid #ffc9c9;
      border-radius: 12px;
      color: #8a1c1c;
      font-weight: 800;
    }
    .actions{
      margin-top: 18px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <main class="container">
    <div class="wrap">
      <h1>Pagamento</h1>

      <p class="muted" id="statusText">
        Estamos confirmando seu pagamento...
      </p>

      <div id="resultBox"></div>

      <div class="actions" id="actions" style="display:none;">
        <a id="downloadBtn" class="btn btn--primary" href="#">Baixar arquivo</a>
      </div>
    </div>
  </main>

  <script type="module">
    import { CONFIG } from "../assets/js/config.js";

    const params = new URLSearchParams(window.location.search);
    const paymentId =
      params.get("payment_id") ||
      params.get("collection_id") ||
      params.get("paymentId");

    const statusText = document.getElementById("statusText");
    const resultBox = document.getElementById("resultBox");
    const actions = document.getElementById("actions");
    const downloadBtn = document.getElementById("downloadBtn");

    if (!paymentId) {
      statusText.textContent = "Pagamento n√£o identificado.";
      resultBox.innerHTML = `<div class="err">N√£o foi poss√≠vel identificar o pagamento.</div>`;
    } else {
      checkPayment();
    }

    async function checkPayment(){
      try {
        const res = await fetch(
          CONFIG.BASE_API_URL + "/api/check?payment_id=" + encodeURIComponent(paymentId),
          { cache: "no-store" }
        );

        const data = await res.json().catch(()=> ({}));

        if (!res.ok) {
          throw new Error("Erro ao verificar pagamento");
        }

        if (!data.approved) {
          statusText.textContent = "Pagamento ainda n√£o confirmado.";
          resultBox.innerHTML = `
            <div class="wait">
              Seu pagamento est√° sendo processado.<br>
              Se voc√™ acabou de pagar, aguarde alguns instantes e atualize esta p√°gina.
            </div>
          `;
          return;
        }

        // APROVADO
        statusText.textContent = "Pagamento confirmado!";
        resultBox.innerHTML = `
          <div class="ok">
            Seu pagamento foi aprovado com sucesso üéâ<br>
            Clique abaixo para baixar seu arquivo.
          </div>
        `;

        downloadBtn.href =
          CONFIG.BASE_API_URL + "/api/download?token=" + encodeURIComponent(data.token);

        actions.style.display = "flex";

      } catch (e) {
        statusText.textContent = "Erro ao verificar pagamento.";
        resultBox.innerHTML = `
          <div class="err">
            Ocorreu um erro ao confirmar seu pagamento.<br>
            Tente atualizar a p√°gina.
          </div>
        `;
      }
    }
  </script>
</body>
</html>
