<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Produto</title>

  <link rel="stylesheet" href="../assets/css/base.css" />
  <link rel="stylesheet" href="../assets/css/layout.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />

  <style>
    .top-logo{
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:16px;
      border-bottom:1px solid var(--border);
      background:#fff;
    }
    .top-logo.left{ justify-content:flex-start; padding-left:24px; }
    .top-logo.purple{ background:#B389FD; }
    .top-logo img{ max-height:48px; }
    .top-logo .ph{ color: var(--muted); font-weight: 900; }

    .box{
      max-width: 1100px;
      margin: 0 auto;
    }

    .gallery{
      display:grid;
      grid-template-columns: 90px 1fr;
      gap:12px;
      margin-top: 12px;
    }
    .thumbs{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .thumbs img{
      width:100%;
      border-radius:10px;
      cursor:pointer;
      border:2px solid transparent;
    }
    .thumbs img.active{ border-color:#B389FD; }
    .main-img img{
      width:100%;
      border-radius:12px;
    }

    .price{
      font-size:28px;
      font-weight:900;
      color:#2b1d43;
      margin-top: 12px;
    }
    .muted{ color:var(--muted); }

    .important{
      background:#f7f4ff;
      border:1px solid #e5dcff;
      border-radius:12px;
      padding:12px;
      margin:12px 0;
    }

    .btnWide{ width:100%; margin:16px 0; }
  </style>
</head>

<body>
  <header id="top" class="top-logo">
    <span id="logoPh" class="ph">Logo</span>
    <img id="logo" alt="Logo" style="display:none;" />
  </header>

  <main class="container">
    <div class="box card" id="content">
      <p class="muted">Carregando produto...</p>
    </div>
  </main>

  <div data-include="../components/footer.html"></div>

  <script type="module">
    import { CONFIG } from "../assets/js/config.js";
    import { loadPartials } from "../assets/js/api.js";

    window.addEventListener("DOMContentLoaded", () => loadPartials());

    async function loadRemoteConfig(){
      try {
        const res = await fetch(CONFIG.BASE_API_URL + "/api/config", { cache: "no-store" });
        if (!res.ok) return { __error: `Erro ${res.status} ao buscar config` };
        const data = await res.json();
        if (data === null) return null; // ainda não configurado
        return data;
      } catch (e) {
        return { __error: "Falha de rede/CORS ao buscar config" };
      }
    }

    function esc(str){
      return String(str || "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function render(cfg){
      const content = document.getElementById("content");

      // topo
      const top = document.getElementById("top");
      const logo = document.getElementById("logo");
      const logoPh = document.getElementById("logoPh");

      top.classList.remove("left","purple");
      if (cfg.header?.align === "left") top.classList.add("left");
      if (cfg.header?.bg === "purple") top.classList.add("purple");

      if (cfg.header?.logoUrl) {
        logo.src = cfg.header.logoUrl;
        logo.style.display = "block";
        logoPh.style.display = "none";
      } else {
        logo.style.display = "none";
        logoPh.style.display = "block";
      }

      document.title = cfg.title || "Produto";

      // galeria
      let galleryHTML = "";
      if (cfg.images?.length) {
        galleryHTML = `
          <div class="gallery">
            <div class="thumbs">
              ${cfg.images.map((img,i)=>`
                <img src="${img}" data-i="${i}" class="${i===0?'active':''}" alt="thumb">
              `).join("")}
            </div>
            <div class="main-img">
              <img id="mainImg" src="${cfg.images[0]}" alt="imagem principal">
            </div>
          </div>
        `;
      }

      // infos importantes
      let importantHTML = "";
      if (cfg.importantLines?.length) {
        importantHTML = `
          <div class="important">
            ${cfg.importantLines.map(l=>`<div>• ${esc(l)}</div>`).join("")}
          </div>
        `;
      }

      // pagamentos
      const pay = [];
      if (cfg.payments?.pix) pay.push("Pix");
      if (cfg.payments?.card) pay.push("Cartão");
      if (cfg.payments?.boleto) pay.push("Boleto");

      content.innerHTML = `
        <h1>${esc(cfg.title || "")}</h1>
        ${galleryHTML}
        ${importantHTML}

        <div class="price">R$ ${esc(cfg.pixPrice || "")}</div>
        ${cfg.cardPrice ? `<div class="muted">Cartão: R$ ${esc(cfg.cardPrice)}</div>` : ""}
        ${(cfg.installments && cfg.installmentValue) ? `<div class="muted">até ${esc(cfg.installments)}x de R$ ${esc(cfg.installmentValue)}</div>` : ""}

        <div class="muted" style="margin:10px 0;">
          Formas de pagamento: ${pay.length ? pay.join(", ") : "—"}
        </div>

        <button class="btn btn--primary btnWide" id="buyBtn">Comprar agora</button>

        <div class="muted" style="white-space:pre-line; margin-top: 8px;">
          ${esc(cfg.descriptionText || "")}
        </div>
      `;

      // thumbs troca imagem
      const mainImg = document.getElementById("mainImg");
      document.querySelectorAll(".thumbs img").forEach(el=>{
        el.addEventListener("click", ()=>{
          document.querySelectorAll(".thumbs img").forEach(i=>i.classList.remove("active"));
          el.classList.add("active");
          if (mainImg) mainImg.src = el.src;
        });
      });

      document.getElementById("buyBtn")?.addEventListener("click", () => {
        alert("Próximo passo: ligar Mercado Pago.");
      });
    }

    (async () => {
      const content = document.getElementById("content");
      const cfg = await loadRemoteConfig();

      if (cfg && cfg.__error) {
        content.innerHTML = `
          <h2>Erro ao carregar</h2>
          <p class="muted">${cfg.__error}</p>
          <p class="muted">Abra o console (F12) para ver detalhes. Se for CORS, precisamos ajustar o Worker.</p>
        `;
        return;
      }

      if (cfg === null) {
        content.innerHTML = `
          <h2>Produto ainda não configurado</h2>
          <p class="muted">Abra o admin e clique em “Salvar no servidor”. Depois atualize esta página.</p>
        `;
        return;
      }

      render(cfg);
    })();
  </script>
</body>
</html>
