<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Produto</title>

  <!-- Google Analytics GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NKZTYFWTH4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-NKZTYFWTH4', { anonymize_ip: true });
  </script>

  <link rel="stylesheet" href="../assets/css/base.css" />
  <link rel="stylesheet" href="../assets/css/layout.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />

  <script type="module">
    import { loadPartials } from "../assets/js/api.js";
    window.addEventListener("DOMContentLoaded", () => loadPartials());
  </script>
</head>

<body>
  <header id="topLogo" class="top-logo is-center">
    <span id="logoPlaceholder" class="ph">Logo</span>
    <img id="logoImg" alt="Logo" style="display:none;">
  </header>

  <main class="container">
    <section class="product" id="productWrap">

      <div class="gallery">
        <div class="thumbs" id="thumbs"></div>
        <div class="main-image">
          <img id="mainImg" src="../assets/img/hero.png" alt="Imagem principal">
        </div>
      </div>

      <div class="product-info">
        <h1 id="productTitle">Carregando…</h1>
        <div class="code" id="productCode"></div>

        <div class="notice">
          <strong>Informações importantes</strong>
          <ul class="small" id="importantList"></ul>
        </div>

        <div id="optionsArea"></div>

        <div class="price-box">
          <div class="price-main" id="pixPriceLine">—</div>
          <div class="price-sub small" id="cardPriceLine"></div>

          <div id="paymentBadges" style="margin-top:10px;"></div>

          <p class="small muted" style="margin-top:10px;">
            Após o pagamento, o link de download será enviado para o e-mail informado no Mercado Pago.
          </p>

          <button id="buyNowBtn" class="btn btn--primary" style="margin-top:14px;">
            Comprar agora
          </button>
        </div>
      </div>
    </section>

    <section class="desc-bottom">
      <h2>Descrição</h2>
      <p id="descText">(Sem descrição)</p>
    </section>
  </main>

  <div data-include="../components/footer.html"></div>

  <script type="module">
    import { CONFIG } from "../assets/js/config.js";

    let CURRENT_CFG = null;

    function esc(str){
      return String(str || "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    async function loadRemoteConfig(){
      try {
        const res = await fetch(CONFIG.BASE_API_URL + "/api/config", { cache: "no-store" });
        return await res.json();
      } catch {
        return { __error: "Falha ao carregar configuração" };
      }
    }

    function applyTopLogo(cfg){
      const img = document.getElementById("logoImg");
      const ph = document.getElementById("logoPlaceholder");

      if (cfg.header?.logoUrl) {
        img.src = cfg.header.logoUrl;
        img.style.display = "block";
        ph.style.display = "none";
      }
    }

    function renderGallery(cfg){
      const thumbs = document.getElementById("thumbs");
      const mainImg = document.getElementById("mainImg");
      thumbs.innerHTML = "";

      const imgs = cfg.images || [];
      if (!imgs.length) return;

      mainImg.src = imgs[0];

      imgs.forEach(src => {
        const b = document.createElement("button");
        b.className = "thumb";
        b.innerHTML = `<img src="${src}" alt="">`;
        b.onclick = () => mainImg.src = src;
        thumbs.appendChild(b);
      });
    }

    function render(cfg){
      CURRENT_CFG = cfg;
      document.title = cfg.title || "Produto";
      document.getElementById("productTitle").textContent = cfg.title || "";
      document.getElementById("productCode").textContent = cfg.code ? `(Cód: ${cfg.code})` : "";

      const ul = document.getElementById("importantList");
      ul.innerHTML = "";
      (cfg.importantLines || []).forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        ul.appendChild(li);
      });

      document.getElementById("pixPriceLine").innerHTML =
        `R$ ${esc(cfg.pixPrice)} <span class="small muted">no pix</span>`;

      document.getElementById("cardPriceLine").textContent =
        cfg.cardPrice ? `Cartão: R$ ${cfg.cardPrice}` : "";

      document.getElementById("paymentBadges").innerHTML =
        Object.entries(cfg.payments || {})
          .filter(([_,v])=>v)
          .map(([k])=>`<span class="tag">${k}</span>`)
          .join(" ");

      document.getElementById("descText").textContent =
        cfg.descriptionText || "";

      applyTopLogo(cfg);
      renderGallery(cfg);
    }

    async function comprarAgora(){
      fetch(CONFIG.BASE_API_URL + "/api/track", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ event:"checkout_click" })
      }).catch(()=>{});

      const res = await fetch(CONFIG.BASE_API_URL + "/api/create_preference", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({})
      });

      const data = await res.json();
      if (!data.init_point) {
        alert("Erro ao iniciar pagamento");
        return;
      }

      fetch(CONFIG.BASE_API_URL + "/api/track", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ event:"checkout_redirect" })
      }).catch(()=>{});

      window.location.href = data.init_point;
    }

    (async ()=>{
      const cfg = await loadRemoteConfig();
      render(cfg);

      fetch(CONFIG.BASE_API_URL + "/api/track", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ event:"page_view" })
      }).catch(()=>{});

      document.getElementById("buyNowBtn").onclick = comprarAgora;
    })();
  </script>
</body>
</html>
